# Registration Flow - Visual Diagram

## New Flow (After Changes)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         USER REGISTRATION FLOW                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Step 1: REGISTRATION
โโโโโโโโโโโโ
โ  User    โ  Submits registration form
โ          โ  (email, password, name, etc.)
โโโโโโฌโโโโโโ
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  POST /api/auth/register                                       โ
โ                                                                โ
โ  1. Check if email exists in 'users' table โ Error if exists  โ
โ  2. Check if email exists in 'pending_users' table            โ
โ  3. Hash password                                             โ
โ  4. Generate OTP (6-digit code)                               โ
โ  5. CREATE/UPDATE record in 'pending_users' table             โ
โ     โ NO USER ACCOUNT CREATED YET                            โ
โ  6. Send verification email with OTP                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  DATABASE: pending_users table                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ id: "clx..."                                             โ  โ
โ  โ email: "user@example.com"                                โ  โ
โ  โ password: "$2a$12$..." (hashed)                          โ  โ
โ  โ firstName: "John"                                        โ  โ
โ  โ lastName: "Doe"                                          โ  โ
โ  โ verificationOtp: "123456"                                โ  โ
โ  โ verificationOtpExpiry: 2024-11-30T12:25:00Z             โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโ
โ  Email   โ  ๐ง Verification email sent
โ  Service โ  "Your OTP is: 123456"
โโโโโโโโโโโโ


Step 2: ATTEMPT LOGIN (BEFORE VERIFICATION)
โโโโโโโโโโโโ
โ  User    โ  Tries to login
โ          โ  (email, password)
โโโโโโฌโโโโโโ
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  POST /api/auth/login                                          โ
โ                                                                โ
โ  1. Check 'pending_users' table for email                     โ
โ  2. โ FOUND! User has pending registration                    โ
โ  3. Return 403 Forbidden                                      โ
โ     "Please verify your email to complete registration"       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโ
โ  User    โ  โ Login blocked
โ          โ  Must verify email first
โโโโโโโโโโโโ


Step 3: EMAIL VERIFICATION
โโโโโโโโโโโโ
โ  User    โ  Enters OTP from email
โ          โ  (email, otp)
โโโโโโฌโโโโโโ
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  POST /api/auth/verify-email                                   โ
โ                                                                โ
โ  1. Find record in 'pending_users' table by email             โ
โ  2. Validate OTP matches                                      โ
โ  3. Check OTP not expired (10 minutes)                        โ
โ  4. โ CREATE USER ACCOUNT in 'users' table                   โ
โ  5. DELETE record from 'pending_users' table                  โ
โ  6. Generate JWT token                                        โ
โ  7. Set HTTP-only cookie                                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  DATABASE: users table                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ id: "clx..."                                             โ  โ
โ  โ email: "user@example.com"                                โ  โ
โ  โ password: "$2a$12$..." (hashed)                          โ  โ
โ  โ firstName: "John"                                        โ  โ
โ  โ lastName: "Doe"                                          โ  โ
โ  โ verified: true โ                                        โ  โ
โ  โ createdAt: 2024-11-30T12:30:00Z                         โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโ
โ  User    โ  โ Account created & logged in
โ          โ  Redirected to dashboard
โโโโโโโโโโโโ


Step 4: LOGIN (AFTER VERIFICATION)
โโโโโโโโโโโโ
โ  User    โ  Logs in
โ          โ  (email, password)
โโโโโโฌโโโโโโ
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  POST /api/auth/login                                          โ
โ                                                                โ
โ  1. Check 'pending_users' table โ Not found โ                โ
โ  2. Find user in 'users' table                                โ
โ  3. Verify password                                           โ
โ  4. Generate JWT token                                        โ
โ  5. Set HTTP-only cookie                                      โ
โ  6. Return user data + token                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโ
โ  User    โ  โ Logged in successfully
โ          โ  Access to protected routes
โโโโโโโโโโโโ


โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        AUTOMATIC CLEANUP
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  CRON JOB (Daily at 2:00 AM)                                   โ
โ                                                                โ
โ  1. Find all records in 'pending_users' table                 โ
โ  2. Where verificationOtpExpiry < (now - 24 hours)            โ
โ  3. DELETE expired pending registrations                      โ
โ  4. Log cleanup results                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  DATABASE: pending_users table                                  โ
โ  ๐งน Expired registrations removed                               โ
โ  Only active pending registrations remain                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ


โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        RESEND OTP FLOW
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโ
โ  User    โ  Didn't receive OTP or expired
โ          โ  Requests new OTP
โโโโโโฌโโโโโโ
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  POST /api/auth/resend-verification-otp                        โ
โ                                                                โ
โ  1. Find record in 'pending_users' table                      โ
โ  2. Generate new OTP                                          โ
โ  3. Update verificationOtp and verificationOtpExpiry          โ
โ  4. Send new verification email                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโ
โ  Email   โ  ๐ง New verification email sent
โ  Service โ  "Your new OTP is: 789012"
โโโโโโโโโโโโ


โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        KEY DIFFERENCES
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

OLD FLOW:
  Register โ User created (unverified) โ Verify โ Update verified=true

NEW FLOW:
  Register โ Pending user โ Verify โ User created (verified=true)

BENEFITS:
  โ No unverified accounts in main users table
  โ Automatic cleanup of abandoned registrations
  โ Cleaner database structure
  โ Better security against spam
```

## Database Tables

### pending_users (Temporary Storage)
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ pending_users                                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ id                    String (cuid)                         โ
โ email                 String (unique)                       โ
โ password              String (hashed)                       โ
โ firstName             String                                โ
โ lastName              String                                โ
โ phone                 String? (optional)                    โ
โ role                  UserRole (default: FARMER)            โ
โ verificationOtp       String                                โ
โ verificationOtpExpiry DateTime                              โ
โ createdAt             DateTime                              โ
โ updatedAt             DateTime                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ
        โ After verification
        โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ users (Permanent Storage)                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ id                    String (cuid)                         โ
โ email                 String (unique)                       โ
โ password              String (hashed)                       โ
โ firstName             String                                โ
โ lastName              String                                โ
โ phone                 String? (optional)                    โ
โ avatar                String? (optional)                    โ
โ role                  UserRole (default: FARMER)            โ
โ verified              Boolean (always true)                 โ
โ resetToken            String? (for password reset)          โ
โ resetTokenExpiry      DateTime?                             โ
โ createdAt             DateTime                              โ
โ updatedAt             DateTime                              โ
โ + Relations (farms, recommendations, etc.)                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Error Scenarios

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ SCENARIO: Email already registered                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ POST /api/auth/register                                     โ
โ โ Check 'users' table                                       โ
โ โ Email found                                               โ
โ โ Return 409 Conflict                                       โ
โ   "User already exists with this email"                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ SCENARIO: Invalid OTP                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ POST /api/auth/verify-email                                 โ
โ โ Find pending user                                         โ
โ โ Compare OTP                                               โ
โ โ Mismatch                                                  โ
โ โ Return 400 Bad Request                                    โ
โ   "Invalid verification code"                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ SCENARIO: Expired OTP                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ POST /api/auth/verify-email                                 โ
โ โ Find pending user                                         โ
โ โ Check verificationOtpExpiry                               โ
โ โ Expired (> 10 minutes old)                                โ
โ โ Return 400 Bad Request                                    โ
โ   "Verification code has expired"                           โ
โ โ User must request new OTP                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ SCENARIO: No pending registration found                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ POST /api/auth/verify-email                                 โ
โ โ Search 'pending_users' table                              โ
โ โ Not found                                                 โ
โ โ Return 404 Not Found                                      โ
โ   "No pending registration found"                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```
