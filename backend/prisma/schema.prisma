// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model PendingUser {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // hashed password
  firstName String
  lastName  String
  phone     String?
  role      UserRole @default(FARMER)
  
  // Email verification
  verificationOtp String
  verificationOtpExpiry DateTime
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("pending_users")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  phone     String?
  avatar    String?
  role      UserRole @default(FARMER)
  verified  Boolean  @default(true) // Always true since account is created after verification
  
  // Password reset
  resetToken String?
  resetTokenExpiry DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  farms            Farm[]
  recommendations  CropRecommendation[]
  yieldPredictions YieldPrediction[]
  diseaseDetections DiseaseDetection[]
  calendarTasks    CalendarTask[]
  forumPosts       ForumPost[]
  forumComments    ForumComment[]
  labourAlerts     LabourAlert[]
  
  // Forum Relations
  forumThreads     ForumThread[]
  forumReplies     ForumReply[]
  forumLikes       ForumLike[]
  marketplaceListings ForumMarketplace[]
  marketplaceReviews MarketplaceReview[]
  knowledgeArticles KnowledgeArticle[]
  expertSessions   ExpertSession[]
  sessionParticipations SessionParticipant[]
  reputation       UserReputation?

  @@map("users")
}

enum UserRole {
  FARMER
  AGRONOMIST
  ADMIN
}

model Farm {
  id          String  @id @default(cuid())
  name        String
  location    String
  latitude    Float
  longitude   Float
  area        Float   // in acres
  soilType    String
  irrigationType String
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
  recommendations CropRecommendation[]
  yieldPredictions YieldPrediction[]

  @@map("farms")
}

model CropRecommendation {
  id            String   @id @default(cuid())
  userId        String
  farmId        String?
  
  // Input parameters
  nitrogen      Float
  phosphorus    Float
  potassium     Float
  ph            Float
  temperature   Float
  humidity      Float
  rainfall      Float
  season        String
  marketDemand  String?
  
  // Results
  recommendations Json    // Array of crop recommendations with scores
  confidence     Float
  createdAt      DateTime @default(now())

  // Relations
  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  farm Farm? @relation(fields: [farmId], references: [id], onDelete: SetNull)

  @@map("crop_recommendations")
}

model YieldPrediction {
  id            String   @id @default(cuid())
  userId        String
  farmId        String?
  
  // Input parameters
  crop          String
  area          Float
  avgRainfall   Float
  pesticideUsage Float
  temperature   Float
  pastYields    Json?    // Historical yield data
  
  // Results
  predictedYield Float
  confidenceInterval Json // {lower: number, upper: number}
  confidence    Float
  createdAt     DateTime @default(now())

  // Relations
  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  farm Farm? @relation(fields: [farmId], references: [id], onDelete: SetNull)

  @@map("yield_predictions")
}

model DiseaseDetection {
  id            String   @id @default(cuid())
  userId        String
  
  // Input
  imagePath     String
  cropType      String?
  
  // Results
  diseaseName   String
  severity      String   // LOW, MEDIUM, HIGH
  confidence    Float
  treatment     Json     // Treatment recommendations
  annotations   Json?    // Bounding boxes, heatmaps
  createdAt     DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("disease_detections")
}

model CalendarTask {
  id          String     @id @default(cuid())
  userId      String
  title       String
  description String?
  taskType    TaskType
  crop        String?
  startDate   DateTime
  endDate     DateTime?
  completed   Boolean    @default(false)
  priority    Priority   @default(MEDIUM)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("calendar_tasks")
}

enum TaskType {
  SOWING
  IRRIGATION
  FERTILIZATION
  PEST_CONTROL
  HARVESTING
  MARKET_ANALYSIS
  OTHER
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model CropPrice {
  id        String   @id @default(cuid())
  crop      String
  market    String
  price     Float    // per unit
  unit      String   // kg, quintal, etc.
  date      DateTime
  source    String?  // API source or manual entry
  createdAt DateTime @default(now())

  @@unique([crop, market, date])
  @@map("crop_prices")
}

model WeatherData {
  id          String   @id @default(cuid())
  latitude    Float
  longitude   Float
  temperature Float
  humidity    Float
  rainfall    Float
  windSpeed   Float?
  pressure    Float?
  date        DateTime
  forecast    Boolean  @default(false) // true for forecast, false for historical
  createdAt   DateTime @default(now())

  @@unique([latitude, longitude, date, forecast])
  @@map("weather_data")
}

model ForumPost {
  id        String   @id @default(cuid())
  userId    String
  title     String
  content   String
  category  String
  tags      String[] @default([])
  likes     Int      @default(0)
  views     Int      @default(0)
  pinned    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user     User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments ForumComment[]

  @@map("forum_posts")
}

model ForumComment {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  content   String
  likes     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  post ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@map("forum_comments")
}

model LabourAlert {
  id          String      @id @default(cuid())
  userId      String
  title       String
  description String
  labourType  String      // harvesting, planting, etc.
  workersNeeded Int
  payRate     Float?
  location    String
  startDate   DateTime
  endDate     DateTime
  status      AlertStatus @default(ACTIVE)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("labour_alerts")
}

enum AlertStatus {
  ACTIVE
  FILLED
  EXPIRED
  CANCELLED
}

// Labour Scheduling Models
model Worker {
  id          String   @id @default(cuid())
  userId      String
  firstName   String
  lastName    String
  phone       String
  email       String?
  skills      String[] @default([]) // e.g., ["harvesting", "planting", "irrigation"]
  hourlyRate  Float
  availability Json    // Weekly availability schedule
  status      WorkerStatus @default(ACTIVE)
  rating      Float?   @default(0)
  totalHours  Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  shifts      Shift[]
  absences    WorkerAbsence[]

  @@map("workers")
}

enum WorkerStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
}

model Shift {
  id          String      @id @default(cuid())
  workerId    String
  taskId      String
  date        DateTime
  startTime   DateTime
  endTime     DateTime
  breakMinutes Int        @default(0)
  actualStart DateTime?
  actualEnd   DateTime?
  status      ShiftStatus @default(SCHEDULED)
  notes       String?
  overtimeHours Float     @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  worker      Worker      @relation(fields: [workerId], references: [id], onDelete: Cascade)
  task        LabourTask  @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("shifts")
}

enum ShiftStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

model LabourTask {
  id              String       @id @default(cuid())
  userId          String
  title           String
  description     String?
  taskType        String       // harvesting, planting, irrigation, etc.
  crop            String?
  location        String
  priority        TaskPriority @default(MEDIUM)
  requiredWorkers Int
  requiredSkills  String[]     @default([])
  estimatedHours  Float
  startDate       DateTime
  endDate         DateTime
  status          TaskStatus   @default(PENDING)
  progress        Float        @default(0) // 0-100
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  shifts          Shift[]
  alerts          ScheduleAlert[]

  @@map("labour_tasks")
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TaskStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  DELAYED
  CANCELLED
}

model ScheduleAlert {
  id          String      @id @default(cuid())
  userId      String
  taskId      String?
  alertType   AlertType
  title       String
  message     String
  severity    AlertSeverity @default(INFO)
  isRead      Boolean     @default(false)
  actionRequired Boolean  @default(false)
  metadata    Json?       // Additional context
  createdAt   DateTime    @default(now())
  expiresAt   DateTime?

  // Relations
  task        LabourTask? @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("schedule_alerts")
}

enum AlertType {
  UPCOMING_TASK
  SHIFT_CHANGE
  OVERTIME_WARNING
  DEADLINE_APPROACHING
  LABOR_SHORTAGE
  LABOR_SURPLUS
  WORKER_ABSENCE
  TASK_DELAYED
  WEATHER_IMPACT
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
}

model WorkerAbsence {
  id          String   @id @default(cuid())
  workerId    String
  startDate   DateTime
  endDate     DateTime
  reason      String?
  approved    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  worker      Worker   @relation(fields: [workerId], references: [id], onDelete: Cascade)

  @@map("worker_absences")
}

model LabourAnalytics {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime
  totalWorkers    Int
  activeWorkers   Int
  totalHours      Float
  overtimeHours   Float
  efficiency      Float    // 0-100
  costPerHour     Float
  tasksCompleted  Int
  tasksDelayed    Int
  metadata        Json?    // Additional metrics
  createdAt       DateTime @default(now())

  @@unique([userId, date])
  @@map("labour_analytics")
}

model ChatMessage {
  id        String   @id @default(cuid())
  sessionId String   @unique
  message   String
  response  String?
  language  String   @default("en")
  createdAt DateTime @default(now())

  @@map("chat_messages")
}


// ==================== FARMER FORUM MODELS ====================

model ForumCategory {
  id          String        @id @default(cuid())
  name        String
  slug        String        @unique
  description String?
  icon        String?       // Icon name or emoji
  color       String?       // Hex color for category
  order       Int           @default(0)
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  threads     ForumThread[]
  
  @@map("forum_categories")
}

model ForumThread {
  id          String        @id @default(cuid())
  categoryId  String
  authorId    String
  title       String
  content     String        @db.Text
  slug        String        @unique
  isPinned    Boolean       @default(false)
  isLocked    Boolean       @default(false)
  viewCount   Int           @default(0)
  likeCount   Int           @default(0)
  tags        String[]      // Array of tags
  images      String[]      // Array of image URLs
  location    String?       // User's location/district
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  category    ForumCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  author      User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  replies     ForumReply[]
  likes       ForumLike[]
  
  @@index([categoryId])
  @@index([authorId])
  @@index([createdAt])
  @@map("forum_threads")
}

model ForumReply {
  id          String        @id @default(cuid())
  threadId    String
  authorId    String
  content     String        @db.Text
  parentId    String?       // For nested replies
  images      String[]      // Array of image URLs
  likeCount   Int           @default(0)
  isExpert    Boolean       @default(false) // Mark expert answers
  isBestAnswer Boolean      @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  thread      ForumThread   @relation(fields: [threadId], references: [id], onDelete: Cascade)
  author      User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent      ForumReply?   @relation("ReplyToReply", fields: [parentId], references: [id], onDelete: Cascade)
  replies     ForumReply[]  @relation("ReplyToReply")
  likes       ForumLike[]
  
  @@index([threadId])
  @@index([authorId])
  @@index([createdAt])
  @@map("forum_replies")
}

model ForumLike {
  id        String       @id @default(cuid())
  userId    String
  threadId  String?
  replyId   String?
  createdAt DateTime     @default(now())
  
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  thread    ForumThread? @relation(fields: [threadId], references: [id], onDelete: Cascade)
  reply     ForumReply?  @relation(fields: [replyId], references: [id], onDelete: Cascade)
  
  @@unique([userId, threadId])
  @@unique([userId, replyId])
  @@index([userId])
  @@map("forum_likes")
}

model ForumMarketplace {
  id          String              @id @default(cuid())
  sellerId    String
  title       String
  description String              @db.Text
  category    MarketplaceCategory
  price       Float
  unit        String?             // kg, quintal, piece, etc.
  quantity    Float?
  location    String
  district    String?
  state       String?
  images      String[]
  condition   ProductCondition    @default(NEW)
  status      MarketplaceStatus   @default(AVAILABLE)
  contactPhone String?
  contactEmail String?
  viewCount   Int                 @default(0)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  expiresAt   DateTime?
  
  seller      User                @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  reviews     MarketplaceReview[]
  
  @@index([sellerId])
  @@index([category])
  @@index([status])
  @@index([createdAt])
  @@map("forum_marketplace")
}

model MarketplaceReview {
  id          String            @id @default(cuid())
  listingId   String
  reviewerId  String
  rating      Int               // 1-5
  comment     String?           @db.Text
  createdAt   DateTime          @default(now())
  
  listing     ForumMarketplace  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  reviewer    User              @relation(fields: [reviewerId], references: [id], onDelete: Cascade)
  
  @@unique([listingId, reviewerId])
  @@index([listingId])
  @@map("marketplace_reviews")
}

model KnowledgeArticle {
  id          String              @id @default(cuid())
  authorId    String
  title       String
  slug        String              @unique
  content     String              @db.Text
  excerpt     String?
  category    ArticleCategory
  tags        String[]
  coverImage  String?
  readTime    Int?                // Minutes
  viewCount   Int                 @default(0)
  likeCount   Int                 @default(0)
  isPublished Boolean             @default(false)
  isFeatured  Boolean             @default(false)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  publishedAt DateTime?
  
  author      User                @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  @@index([authorId])
  @@index([category])
  @@index([isPublished])
  @@map("knowledge_articles")
}

model ExpertSession {
  id          String              @id @default(cuid())
  expertId    String
  title       String
  description String              @db.Text
  scheduledAt DateTime
  duration    Int                 // Minutes
  maxParticipants Int?
  status      SessionStatus       @default(SCHEDULED)
  meetingLink String?
  tags        String[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  
  expert      User                @relation(fields: [expertId], references: [id], onDelete: Cascade)
  participants SessionParticipant[]
  
  @@index([expertId])
  @@index([scheduledAt])
  @@map("expert_sessions")
}

model SessionParticipant {
  id          String         @id @default(cuid())
  sessionId   String
  userId      String
  status      ParticipantStatus @default(REGISTERED)
  joinedAt    DateTime?
  createdAt   DateTime       @default(now())
  
  session     ExpertSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
  @@map("session_participants")
}

model UserReputation {
  id              String   @id @default(cuid())
  userId          String   @unique
  points          Int      @default(0)
  level           Int      @default(1)
  badges          String[] // Array of badge IDs
  threadsCreated  Int      @default(0)
  repliesPosted   Int      @default(0)
  bestAnswers     Int      @default(0)
  helpfulVotes    Int      @default(0)
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_reputation")
}

// Enums for Forum

enum MarketplaceCategory {
  SEEDS
  FERTILIZERS
  PESTICIDES
  MACHINERY
  TOOLS
  LIVESTOCK
  PRODUCE
  IRRIGATION
  OTHER
}

enum ProductCondition {
  NEW
  LIKE_NEW
  GOOD
  FAIR
  USED
}

enum MarketplaceStatus {
  AVAILABLE
  SOLD
  RESERVED
  EXPIRED
}

enum ArticleCategory {
  CROP_CULTIVATION
  LIVESTOCK
  SOIL_MANAGEMENT
  PEST_CONTROL
  IRRIGATION
  ORGANIC_FARMING
  MARKET_TRENDS
  GOVERNMENT_SCHEMES
  TECHNOLOGY
  SUCCESS_STORIES
}

enum SessionStatus {
  SCHEDULED
  LIVE
  COMPLETED
  CANCELLED
}

enum ParticipantStatus {
  REGISTERED
  ATTENDED
  MISSED
  CANCELLED
}
